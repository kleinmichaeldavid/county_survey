---
output:
  pdf_document:
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, show=FALSE, echo=FALSE)
```

```{r}

depo <- NULL
```

```{r}
library(tidyverse)
library(ggplot2)
## read data
responses1 <- read.csv('survey_responses1.csv', encoding = "UTF-8"); names(responses1) <- gsub("X[0-9]*\\.\\.","", names(responses1))
responses2 <- read.csv('survey_responses2.csv', encoding = "UTF-8"); names(responses2) <- gsub("X[0-9]*\\.\\.","", names(responses2))
responses3 <- read.csv('survey_responses3.csv', encoding = "UTF-8"); names(responses3) <- gsub("X[0-9]*\\.\\.","", names(responses3))
responses4 <- read.csv('survey_responses4.csv', encoding = "UTF-8"); names(responses4) <- gsub("X[0-9]*\\.\\.","", names(responses4))
responses5 <- read.csv('survey_responses5.csv', encoding = "UTF-8"); names(responses5) <- gsub("X[0-9]*\\.\\.","", names(responses5))
responses5 <- responses5[,-which(names(responses5) == "Comments..optional...107")] ## temp since 23 is duplicated

## merge data and separate survey from demog
all_responses <- rbind(responses1, responses2, responses3, responses4, responses5)
codes <- read.table("codes.txt")$V1
all_responses <- all_responses[all_responses[,2] %in% codes,]
ids <- all_responses[,2]
all_responses <- all_responses[,-c(1,2,grep("Comments", names(all_responses)))]
survey_responses <- all_responses[,1:107]
demog_responses <- all_responses[,108:112]

## clean up question strings
questions <- gsub("\\."," ",names(survey_responses)) %>% trimws()
names(survey_responses) <- questions
```

```{r}
## read the category types
categories <- read.csv('question_categories.csv', sep = "\t")
categories$question <- gsub("[^A-Za-z ]"," ",categories$question) %>% trimws() ### if prob here, its likely due to quote - replace with curvies
categories <- categories[match(names(survey_responses), categories$question),] ## re-order to math survey df
```

```{r}
better_cat_names <- data.frame(bad = c('meaning', 'ethics', 'safety', 'learning',
                                        'teamwork', 'recognition', 'leadership',
                                        'management', 'culture', 'conflict', 'commitment',
                                        'pay', 'support', 'communication', 'balance'),
                               good = c('Meaningful Work & Purpose',
                                         'Conduct / Ethics',
                                         'Health & Safety',
                                         'Learning & Development',
                                         'Teamwork', 'Recognition', 'Leadership (SMT)',
                                         'Management Effectiveness',
                                         'Culture', 'Conflict Resolution',
                                         'Service Commitment',
                                         'Pay & Benefits', 'Resources / Support',
                                         'Communication', 'Work / Life Balance'))
categories$category <- better_cat_names$good[match(categories$category, better_cat_names$bad)]



## tidying demographic info
demog_qs <- c("When.were.you.born.", "What.department.are.you.in.",
              "How.long.have.you.been.an.employee.of.L.A.County.", "What.type.of.position.are.you.in.",
              "What.is.your.employment.status.")
demog_qs_df <- data.frame(names = demog_qs,
                          questions = gsub("\\."," ",demog_qs) %>% trimws() %>% paste("?",sep=""),
                          code = c("birth","department","duration","position","status"))
names(demog_responses) <- demog_qs_df$code[match(names(demog_responses), demog_qs_df$names)]
demog_responses$department[demog_responses$department == "Human Resources"] <- "Administration & Human Resources"

## set up question number to category mapping
categories$q_nums <- paste("q", 1:107, sep="_")
names(survey_responses) <- paste("q", 1:107, sep="_")

## transpose
df_resps <- cbind(survey_responses, demog_responses) %>% as.matrix() %>% t() %>% as.data.frame()
df_resps$category <- c(as.character(categories$category[match(categories$q_nums, row.names(df_resps))]),
                       rep('demog', 5))

long_data <- data.frame()
for (n in 1:(ncol(df_resps)-1)) {
  qs <- data.frame(emp = n, question = categories$question, category = df_resps[1:107,"category"], response = df_resps[1:107,n])
  demogs <- df_resps[108:112,n] %>% as.character() %>% rep(107) %>% matrix(ncol = 5, byrow = TRUE) %>% as.data.frame()
  names(demogs) <- c("birth", "department", "duration", "position", "status")
  new_long <- cbind(qs, demogs)
  long_data <- plyr::rbind.fill(long_data, new_long)
}

#################################################
#### OVERALL SUMMARY VIZZES 
############################################

source('organization_functions.R')
source('viz_functions.R')

#### version with 1 row = 1 person

df_tidy <- cbind(survey_responses, demog_responses)

for (demog in c('birth', 'department', 'duration', 'position', 'status')){
  df_tidy[,demog] <- as.character(df_tidy[,demog])
  df_tidy[df_tidy[,demog] == "",demog] <- "<no response>"
  df_tidy[,demog] <- as.factor(df_tidy[,demog])
}

if (!is.null(depo)) {
  df_tidy <- df_tidy[df_tidy$department == depo,]
}

col_cats <- categories$category[match(names(df_tidy), categories$q_nums)]
cats <- unique(categories$category)


## summarize the tidy data into categories
## sort the rows and columns
df_cat_means_by_emp <- category_means_from_tidy(df_tidy, categories, 'department')
df_cat_means_by_dep <- group_means_for_categories(df_cat_means_by_emp, 'group')
categories_best_to_worst <- determine_column_order(df_cat_means_by_dep, 3:17, decreasing = TRUE)
categories_worst_to_best <- determine_column_order(df_cat_means_by_dep, 3:17, decreasing = FALSE)
departments_best_to_worst <- determine_row_order(df_cat_means_by_dep, 'group', 3:17, TRUE)
departments_worst_to_best <- determine_row_order(df_cat_means_by_dep, 'group', 3:17, FALSE)
df_cat_means_by_dep <- sort_columns(df_cat_means_by_dep, 3:17, categories_worst_to_best)
df_cat_means_by_dep <- sort_rows(df_cat_means_by_dep, 'group', departments_best_to_worst)

## get cat means for demogs other than department
df_cat_means_by_pos <- group_means_for_categories(category_means_from_tidy(df_tidy,
                                                                           categories,
                                                                           'position'),'group')
positions_best_to_worst <- determine_row_order(df_cat_means_by_pos, 'group', 3:17, TRUE)
df_cat_means_by_pos <- sort_columns(df_cat_means_by_pos, 3:17, categories_worst_to_best)
df_cat_means_by_pos <- sort_rows(df_cat_means_by_pos, 'group', positions_best_to_worst)

df_cat_means_by_emp <- group_means_for_categories(category_means_from_tidy(df_tidy,
                                                                           categories,
                                                                           'status'), 'group')
statuses_best_to_worst <- determine_row_order(df_cat_means_by_emp, 'group', 3:17, TRUE)
df_cat_means_by_emp <- sort_columns(df_cat_means_by_emp, 3:17, categories_worst_to_best)
df_cat_means_by_emp <- sort_rows(df_cat_means_by_emp, 'group', statuses_best_to_worst)


df_cat_means_by_len <- group_means_for_categories(category_means_from_tidy(df_tidy,
                                                                           categories,
                                                                           'duration'), 'group')
length_order <- c("<no response>", "30 or more years", "20 to 29 years",
                  "10 to 19 years", "1 to 9 years", "less than 1 year")
df_cat_means_by_len <- sort_columns(df_cat_means_by_len, 3:17, categories_worst_to_best)
df_cat_means_by_len <- sort_rows(df_cat_means_by_len, 'group', rev(length_order))


df_cat_means_by_gen <- group_means_for_categories(category_means_from_tidy(df_tidy,
                                                                           categories,
                                                                           'birth'), 'group')
generation_order <- c("<no response>", "1946 to 1964", "1965 to 1976", "1977 to 1995", "1996 or later")
df_cat_means_by_gen <- sort_columns(df_cat_means_by_gen, 3:17, categories_worst_to_best)
df_cat_means_by_gen <- sort_rows(df_cat_means_by_gen, 'group', rev(generation_order))

## get counts for histograms and stacked bars
df_counts <- counts_from_tidy(df_tidy, proportions = FALSE)
df_props <- counts_from_tidy(df_tidy, proportions = TRUE)
df_count_cats <- question_counts_to_categories(df_counts, categories)
df_count_cats <- sort_columns(df_count_cats, 2:16, categories_worst_to_best)
category_scores <- colSums(df_count_cats[,2:16] * 1:5)

######## RESPONDENT DEMOGRAPHICS

# department
department_resps <- demog_responses %>% group_by(department) %>%
  summarize(n = n()) %>% as.data.frame()
names(department_resps) <- c("Department", "Count")
department_resps$Department <- as.character(department_resps$Department)
department_resps$Department[department_resps$Department == ""] <- "/No Response Provided/"
department_resps <- department_resps[order(department_resps$Count,
                                           decreasing = TRUE),]
row.names(department_resps) <- department_resps$Department
department_resps$Department <- NULL

# position
position_resps <- demog_responses %>% group_by(position) %>%
  summarize(n = n()) %>% as.data.frame()
names(position_resps) <- c("Position", "Count")
position_resps$Position <- as.character(position_resps$Position)
position_resps$Position[position_resps$Position == ""] <- "/No Response Provided/"
position_resps <- position_resps[order(position_resps$Count,
                                           decreasing = TRUE),]
row.names(position_resps) <- position_resps$Position
position_resps$Position <- NULL

# status
status_resps <- demog_responses %>% group_by(status) %>%
  summarize(n = n()) %>% as.data.frame()
names(status_resps) <- c("Status", "Count")
status_resps$Status <- as.character(status_resps$Status)
status_resps$Status[status_resps$Status == ""] <- "/No Response Provided/"
status_resps <- status_resps[order(status_resps$Count,
                                           decreasing = TRUE),]
row.names(status_resps) <- status_resps$Status
status_resps$Status <- NULL

# duration
duration_resps <- demog_responses %>% group_by(duration) %>%
  summarize(n = n()) %>% as.data.frame()
names(duration_resps) <- c("Duration", "Count")
duration_resps$Duration <- as.character(duration_resps$Duration)
duration_resps$Duration[duration_resps$Duration == ""] <- "/No Response Provided/"
duration_resps <- duration_resps[order(duration_resps$Count,
                                           decreasing = TRUE),]
row.names(duration_resps) <- duration_resps$Duration
duration_resps$Duration <- NULL

# birth
birth_resps <- demog_responses %>% group_by(birth) %>%
  summarize(n = n()) %>% as.data.frame()
names(birth_resps) <- c("Birth", "Count")
birth_resps$Birth <- as.character(birth_resps$Birth)
birth_resps$Birth[birth_resps$Birth == ""] <- "/No Response Provided/"
birth_resps <- birth_resps[order(birth_resps$Count,
                                           decreasing = TRUE),]
row.names(birth_resps) <- birth_resps$Birth
birth_resps$Birth <- NULL

```



\centering  
![](logo.png)  
\Huge  
Results by Department  
\LARGE  
[Redacted] County Employee Engagement Survey  
\Large  
January 10th, 2019  
\normalsize   
\raggedright  
\newpage

\tableofcontents  
\newpage

\centering  

# Respondent Demographics  

\raggedright  

\centering

\large

**Responses by Department**

```{r, echo=FALSE, results='asis'}
knitr::kable(department_resps)
```

\normalsize

\newpage

\centering  

# Department Overview

\raggedright  
```{r}
demog <- 'department'; type <- 'Departments'
type_singular <- 'Department'; sort_order <- rev(departments_best_to_worst)
```

**Employees' agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}
df_counts_all_by_demog <- plot_demog_bars(df_tidy, demog, sort_order)
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE, type = type)
```

**Average response profile across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

df_counts_all <- data.frame(response = 1:5,
                            value = rowSums(df_counts[,2:ncol(df_counts)])/sum(rowSums(df_counts[,2:ncol(df_counts)])),
                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}


## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

\centering  

## `r type_singular` by Category

\raggedright

```{r, fig.height = 9}
heatmap <- plot_heatmap(df_cat_means_by_dep[,names(df_cat_means_by_dep) != "count"],
                        "group", ylab = "Category")
heatmap
```

\newpage


```{r}
var_counter <- 1
```


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


# Department Results for each Category

## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


## `r var`

\raggedright

**Employee's agreement and disagreement within each `r type_singular`.**

```{r, fig.height = 1.3}

column_cats <- categories$category[match(names(df_tidy), categories$q_nums)]

tidy_only_cat <- cbind(df_tidy[,which(column_cats == var)],
                       select(df_tidy, demog))
df_counts_all_by_demog <- plot_demog_bars(tidy_data = tidy_only_cat,
                                          demog = demog,
                                          sort_order = sort_order,
                                          cols = 1:(ncol(tidy_only_cat)-1))
melted_demog_counts <- reshape2::melt(df_counts_all_by_demog, id = 'response')
output <- plot_strengths_and_weaknesses(melted_demog_counts, by_question = FALSE,
                                        type = type, within_cat = var)
```

**Average response profile in `r var` category across all `r type`. Lines represent the range of individual `r type`.**

```{r, fig.height = 1.9}

title <- "no title"

demog_counts <- df_tidy %>% group_by_(demog) %>% summarize(n = n()) %>% as.data.frame()

df_counts_all <- data.frame(response = 1:5, value = 0, variable = title)
n <- demog_counts$n[match(names(df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)]),
                          demog_counts[,demog])]
for (resp in 1:5){
  mean <- df_counts_all_by_demog[resp,2:ncol(df_counts_all_by_demog)]
  df_counts_all$value[resp] <- sum(mean * n) / sum(n)

}

#count_column_cats <- categories$category[match(names(df_counts), categories$q_nums)]
#df_counts_var <- df_counts[,which(count_column_cats == var)]
#response_counts <- rowSums(df_counts_var[,2:ncol(df_counts_var)])
#df_counts_all <- data.frame(response = 1:5,
#                            value = sweep(df_counts_var,2,colSums(df_counts_var),`/`) %>% rowMeans(),#response_counts/sum(response_counts),
#                            variable = title)

df_count_demog_error_bars <- data.frame(response = 1:5,
                                       min = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMins(),
                                       max = df_counts_all_by_demog[2:ncol(df_counts_all_by_demog)] %>%
                                         as.matrix() %>% matrixStats::rowMaxs())

plot_histogram(1, df_counts_all, df_count_demog_error_bars, NULL, title)
```

**Response profile in `r var` category for each `r type_singular`.**

```{r, fig.align='center', fig.height = 3.5}
## potentially add overall as a top bar (in a new window thing?)
reversed_resps <- df_counts_all_by_demog
reversed_resps$response <- 6 - reversed_resps$response
plot_stacked_bars(reversed_resps, ylab = "Proportion of employees giving each response")
```

\newpage

**`r type_singular` by Statement in `r var` category**

```{r, fig.height = 8.5}

cat_qs <- names(tidy_only_cat)[!(names(tidy_only_cat) %in% demog)]
question_statements <- paste(cat_qs, ' = mean(', cat_qs, ', na.rm = TRUE)', sep="")
#question_statements <- paste(question_statements, collapse = ",")

question_means <- tidy_only_cat %>% group_by_(demog) %>% summarize(count = n()) %>% as.data.frame()
for (q in 1:length(question_statements)){
  new <- tidy_only_cat %>% group_by_(demog) %>% summarize_(question_statements[q]) %>% as.data.frame()
  names(new) <- c('group', cat_qs[q])
  question_means <- cbind(question_means, select(new, cat_qs[q]))
}

qs_worst_to_best <- determine_column_order(question_means, 3:ncol(question_means), decreasing = FALSE)

question_means <- sort_columns(question_means, 3:ncol(question_means), qs_worst_to_best)
question_means <- sort_rows(question_means, demog, rev(sort_order))

real_qs <- categories$question[match(names(question_means[3:ncol(question_means)]),categories$q_nums)]
for (q in 1:length(real_qs)){
  real_qs[q] <- wrapper(real_qs[q], width = 30)
}
names(question_means)[3:ncol(question_means)] <- real_qs

heatmap <- plot_heatmap(question_means[,names(question_means) != "count"],
                        demog, ylab = "Statement")
heatmap
```

\newpage


```{r}
var <- categories_best_to_worst[var_counter]; var_counter <- var_counter + 1
```

\centering 


